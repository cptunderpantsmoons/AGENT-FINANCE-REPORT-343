{
    "sourceFile": "excel_processor.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763913418402,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763913418402,
            "name": "Commit-0",
            "content": "import pandas as pd\nimport numpy as np\nfrom typing import Dict, Any, Tuple, Optional\n\nclass ExcelProcessor:\n    \"\"\"\n    Processes Excel files containing financial data for the AASB Financial Statement Generator.\n    \"\"\"\n    \n    def __init__(self, excel_file_path: str):\n        \"\"\"\n        Initialize the Excel processor with the path to the Excel file.\n        \n        Args:\n            excel_file_path (str): Path to the Excel file containing financial data\n        \"\"\"\n        self.excel_file_path = excel_file_path\n        self.sheets = {}\n        self._load_sheets()\n    \n    def _load_sheets(self):\n        \"\"\"\n        Load all sheets from the Excel file.\n        \"\"\"\n        try:\n            excel_file = pd.ExcelFile(self.excel_file_path)\n            for sheet_name in excel_file.sheet_names:\n                self.sheets[sheet_name] = pd.read_excel(self.excel_file_path, sheet_name=sheet_name)\n        except Exception as e:\n            raise Exception(f\"Error loading Excel file: {str(e)}\")\n    \n    def extract_pl_data(self) -> Dict[str, Any]:\n        \"\"\"\n        Extract profit and loss data from the 'Consol PL' sheet.\n        Prioritizes specific cell lookups, falls back to row label matching.\n        \n        Returns:\n            Dict[str, Any]: Dictionary containing P&L data including EBITDA\n        \"\"\"\n        # Try alternative sheet names\n        sheet_name = None\n        for name in ['Consol PL', 'ConsolPL', 'PL', 'Profit Loss', 'Income Statement']:\n            if name in self.sheets:\n                sheet_name = name\n                break\n        \n        if sheet_name is None:\n            raise ValueError(\"Could not find P&L sheet in Excel file. Expected: 'Consol PL'\")\n        \n        pl_sheet = self.sheets[sheet_name]\n        pl_data = {}\n        \n        try:\n            # First, try to find EBITDA (often in a separate row)\n            for index, row in pl_sheet.iterrows():\n                row_str = row.astype(str)\n                \n                # EBITDA\n                if row_str.str.contains('ebitda', case=False).any():\n                    ebitda_value = self._extract_numeric_value(row)\n                    if ebitda_value is not None:\n                        pl_data['ebitda'] = ebitda_value\n                \n                # Revenue\n                if row_str.str.contains('revenue', case=False).any() and 'revenue' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['revenue'] = value\n                \n                # Cost of sales\n                elif (row_str.str.contains('cost of sales', case=False).any() or \n                      row_str.str.contains('cost of goods sold', case=False).any()) and 'cost_of_sales' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['cost_of_sales'] = abs(value)\n                \n                # Gross profit\n                elif row_str.str.contains('gross profit', case=False).any() and 'gross_profit' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['gross_profit'] = value\n                \n                # Other income\n                elif row_str.str.contains('other income', case=False).any() and 'other_income' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['other_income'] = value\n                \n                # Distribution costs\n                elif (row_str.str.contains('distribution', case=False).any() and \n                      row_str.str.contains('cost', case=False).any()) and 'distribution_costs' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['distribution_costs'] = abs(value)\n                \n                # Administrative expenses\n                elif (row_str.str.contains('administrative', case=False).any() and \n                      row_str.str.contains('expense', case=False).any()) and 'administrative_expenses' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['administrative_expenses'] = abs(value)\n                \n                # Other expenses\n                elif (row_str.str.contains('other', case=False).any() and \n                      row_str.str.contains('expense', case=False).any() and\n                      not row_str.str.contains('income', case=False).any()) and 'other_expenses' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['other_expenses'] = abs(value)\n                \n                # Profit before tax\n                elif row_str.str.contains('profit before tax', case=False).any() and 'profit_before_tax' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['profit_before_tax'] = value\n                \n                # Income tax expense\n                elif row_str.str.contains('income tax', case=False).any() and 'income_tax_expense' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['income_tax_expense'] = abs(value)\n                \n                # Net profit/loss\n                elif ((row_str.str.contains('net', case=False).any() and \n                       row_str.str.contains('profit', case=False).any()) or \n                      (row_str.str.contains('net', case=False).any() and \n                       row_str.str.contains('loss', case=False).any())) and 'net_profit_loss' not in pl_data:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        pl_data['net_profit_loss'] = value\n            \n            # Calculate derived values if not directly found\n            if 'gross_profit' not in pl_data and 'revenue' in pl_data and 'cost_of_sales' in pl_data:\n                pl_data['gross_profit'] = pl_data['revenue'] - pl_data['cost_of_sales']\n            \n            if 'profit_before_tax' not in pl_data:\n                pl_data['profit_before_tax'] = (\n                    pl_data.get('gross_profit', 0) +\n                    pl_data.get('other_income', 0) -\n                    pl_data.get('distribution_costs', 0) -\n                    pl_data.get('administrative_expenses', 0) -\n                    pl_data.get('other_expenses', 0)\n                )\n            \n            if 'net_profit_loss' not in pl_data and 'profit_before_tax' in pl_data:\n                pl_data['net_profit_loss'] = pl_data['profit_before_tax'] - pl_data.get('income_tax_expense', 0)\n            \n            # Ensure EBITDA is set (calculate if missing)\n            if 'ebitda' not in pl_data:\n                # EBITDA = Operating profit before interest, tax, depreciation, amortization\n                # Approximate: Profit before tax + interest + depreciation + amortization\n                # For simplicity, use profit before tax if no other data available\n                pl_data['ebitda'] = pl_data.get('profit_before_tax', 0)\n                \n        except Exception as e:\n            raise Exception(f\"Error extracting P&L data: {str(e)}\")\n        \n        return pl_data\n    \n    def extract_bs_data(self) -> Dict[str, Any]:\n        \"\"\"\n        Extract balance sheet data from the 'Consol BS' sheet.\n        Handles related party loans split between current and non-current.\n        \n        Returns:\n            Dict[str, Any]: Dictionary containing balance sheet data\n        \"\"\"\n        # Try alternative sheet names\n        sheet_name = None\n        for name in ['Consol BS', 'ConsolBS', 'BS', 'Balance Sheet', 'Statement of Financial Position']:\n            if name in self.sheets:\n                sheet_name = name\n                break\n        \n        if sheet_name is None:\n            raise ValueError(\"Could not find Balance Sheet sheet in Excel file. Expected: 'Consol BS'\")\n        \n        bs_sheet = self.sheets[sheet_name]\n        bs_data = {\n            'current_assets': {},\n            'non_current_assets': {},\n            'current_liabilities': {},\n            'non_current_liabilities': {},\n            'equity': {}\n        }\n        \n        try:\n            # Look for key row labels and extract corresponding values\n            for index, row in bs_sheet.iterrows():\n                row_str = row.astype(str)\n                \n                # Cash and cash equivalents\n                if (row_str.str.contains('cash', case=False).any() and \n                    row_str.str.contains('equivalent', case=False).any()) and 'cash' not in bs_data['current_assets']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['current_assets']['cash'] = value\n                \n                # Trade and other receivables\n                elif (row_str.str.contains('trade', case=False).any() and \n                      row_str.str.contains('receivable', case=False).any()) and 'receivables' not in bs_data['current_assets']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['current_assets']['receivables'] = value\n                \n                # Inventories\n                elif row_str.str.contains('inventor', case=False).any() and 'inventories' not in bs_data['current_assets']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['current_assets']['inventories'] = value\n                \n                # Other current assets\n                elif (row_str.str.contains('other', case=False).any() and \n                      row_str.str.contains('current', case=False).any() and \n                      row_str.str.contains('asset', case=False).any()) and 'other' not in bs_data['current_assets']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['current_assets']['other'] = value\n                \n                # Property, plant and equipment\n                elif (row_str.str.contains('property', case=False).any() and \n                      row_str.str.contains('plant', case=False).any()) and 'ppe' not in bs_data['non_current_assets']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['non_current_assets']['ppe'] = value\n                \n                # Intangible assets\n                elif row_str.str.contains('intangible', case=False).any() and 'intangibles' not in bs_data['non_current_assets']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['non_current_assets']['intangibles'] = value\n                \n                # Other non-current assets\n                elif (row_str.str.contains('other', case=False).any() and \n                      row_str.str.contains('non', case=False).any() and \n                      row_str.str.contains('current', case=False).any() and \n                      row_str.str.contains('asset', case=False).any()) and 'other' not in bs_data['non_current_assets']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['non_current_assets']['other'] = value\n                \n                # Trade and other payables\n                elif (row_str.str.contains('trade', case=False).any() and \n                      row_str.str.contains('payable', case=False).any()) and 'payables' not in bs_data['current_liabilities']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['current_liabilities']['payables'] = value\n                \n                # Provisions (current)\n                elif (row_str.str.contains('provision', case=False).any() and\n                      (row_str.str.contains('current', case=False).any() or index < 15)) and 'provisions' not in bs_data['current_liabilities']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['current_liabilities']['provisions'] = value\n                \n                # Provisions (non-current)\n                elif (row_str.str.contains('provision', case=False).any() and\n                      row_str.str.contains('non', case=False).any()) and 'provisions' not in bs_data['non_current_liabilities']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['non_current_liabilities']['provisions'] = value\n                \n                # Related party loans - current\n                elif (row_str.str.contains('related', case=False).any() and \n                      row_str.str.contains('party', case=False).any() and\n                      row_str.str.contains('current', case=False).any()):\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['current_liabilities']['related_party_loans'] = value\n                \n                # Related party loans - non-current\n                elif (row_str.str.contains('related', case=False).any() and \n                      row_str.str.contains('party', case=False).any() and\n                      row_str.str.contains('non', case=False).any()):\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['non_current_liabilities']['related_party_loans'] = value\n                \n                # Other current liabilities\n                elif (row_str.str.contains('other', case=False).any() and \n                      row_str.str.contains('current', case=False).any() and \n                      row_str.str.contains('liabilit', case=False).any()) and 'other' not in bs_data['current_liabilities']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['current_liabilities']['other'] = value\n                \n                # Borrowings (non-current)\n                elif row_str.str.contains('borrowing', case=False).any() and 'borrowings' not in bs_data['non_current_liabilities']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['non_current_liabilities']['borrowings'] = value\n                \n                # Other non-current liabilities\n                elif (row_str.str.contains('other', case=False).any() and \n                      row_str.str.contains('non', case=False).any() and \n                      row_str.str.contains('current', case=False).any() and \n                      row_str.str.contains('liabilit', case=False).any()) and 'other' not in bs_data['non_current_liabilities']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['non_current_liabilities']['other'] = value\n                \n                # Share capital\n                elif (row_str.str.contains('share', case=False).any() and \n                      row_str.str.contains('capital', case=False).any()) and 'share_capital' not in bs_data['equity']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['equity']['share_capital'] = value\n                \n                # Reserves\n                elif row_str.str.contains('reserve', case=False).any() and 'reserves' not in bs_data['equity']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['equity']['reserves'] = value\n                \n                # Retained earnings\n                elif (row_str.str.contains('retained', case=False).any() and \n                      row_str.str.contains('earning', case=False).any()) and 'retained_earnings' not in bs_data['equity']:\n                    value = self._extract_numeric_value(row)\n                    if value is not None:\n                        bs_data['equity']['retained_earnings'] = value\n            \n            # Initialize missing values to 0\n            for key in ['cash', 'receivables', 'inventories', 'other']:\n                if key not in bs_data['current_assets']:\n                    bs_data['current_assets'][key] = 0\n            \n            for key in ['ppe', 'intangibles', 'other']:\n                if key not in bs_data['non_current_assets']:\n                    bs_data['non_current_assets'][key] = 0\n            \n            for key in ['payables', 'provisions', 'other']:\n                if key not in bs_data['current_liabilities']:\n                    bs_data['current_liabilities'][key] = 0\n            \n            for key in ['borrowings', 'provisions', 'other']:\n                if key not in bs_data['non_current_liabilities']:\n                    bs_data['non_current_liabilities'][key] = 0\n            \n            for key in ['share_capital', 'reserves', 'retained_earnings']:\n                if key not in bs_data['equity']:\n                    bs_data['equity'][key] = 0\n            \n            # Calculate totals\n            bs_data['total_current_assets'] = sum(bs_data['current_assets'].values())\n            bs_data['total_non_current_assets'] = sum(bs_data['non_current_assets'].values())\n            bs_data['total_assets'] = bs_data['total_current_assets'] + bs_data['total_non_current_assets']\n            \n            bs_data['total_current_liabilities'] = sum(bs_data['current_liabilities'].values())\n            bs_data['total_non_current_liabilities'] = sum(bs_data['non_current_liabilities'].values())\n            bs_data['total_liabilities'] = bs_data['total_current_liabilities'] + bs_data['total_non_current_liabilities']\n            \n            bs_data['total_equity'] = sum(bs_data['equity'].values())\n            bs_data['total_liabilities_and_equity'] = bs_data['total_liabilities'] + bs_data['total_equity']\n            \n        except Exception as e:\n            raise Exception(f\"Error extracting balance sheet data: {str(e)}\")\n        \n        return bs_data\n    \n    def _extract_numeric_value(self, row) -> Optional[float]:\n        \"\"\"\n        Extract numeric value from a row, handling various formats.\n        Prefers the rightmost numeric column (typically current year).\n        \n        Args:\n            row: Pandas Series representing a row\n            \n        Returns:\n            Optional[float]: Extracted numeric value or None if not found\n        \"\"\"\n        # Look for numeric values in the row (excluding the first column which is typically labels)\n        # Start from the right to get current year value\n        for value in reversed(row[1:]):\n            if pd.notna(value) and isinstance(value, (int, float)):\n                return float(value)\n            elif pd.notna(value) and isinstance(value, str):\n                # Try to convert string to number\n                try:\n                    # Remove common formatting characters\n                    cleaned_value = str(value).replace(',', '').replace('$', '').replace('(', '-').replace(')', '').strip()\n                    if cleaned_value.lower() in ['-', 'nil', 'n/a', '', 'nan']:\n                        continue\n                    return float(cleaned_value)\n                except (ValueError, AttributeError):\n                    continue\n        return None\n    \n    def validate_bs_balances(self, bs_data: Dict[str, Any]) -> Tuple[bool, str]:\n        \"\"\"\n        Validate that Assets = Liabilities + Equity.\n        \n        Args:\n            bs_data (Dict[str, Any]): Balance sheet data\n            \n        Returns:\n            Tuple[bool, str]: (isValid, message)\n        \"\"\"\n        assets = bs_data.get('total_assets', 0)\n        liabilities_equity = bs_data.get('total_liabilities_and_equity', 0)\n        \n        if abs(assets - liabilities_equity) < 1:  # Allow for rounding differences\n            return True, \"Balance sheet balances\"\n        else:\n            difference = assets - liabilities_equity\n            return False, f\"Balance sheet does not balance. Difference: ${difference:,.2f}\"\n    \n    def validate_retained_earnings(self, bs_data: Dict[str, Any], pl_data: Dict[str, Any], \n                                 prior_re: float) -> Tuple[bool, str]:\n        \"\"\"\n        Validate retained earnings rollforward: RE_end = RE_start + Net Profit/(Loss).\n        \n        Args:\n            bs_data (Dict[str, Any]): Balance sheet data\n            pl_data (Dict[str, Any]): Profit and loss data\n            prior_re (float): Prior year retained earnings\n            \n        Returns:\n            Tuple[bool, str]: (isValid, message)\n        \"\"\"\n        current_re = bs_data.get('equity', {}).get('retained_earnings', 0)\n        net_profit = pl_data.get('net_profit_loss', 0)\n        \n        expected_re = prior_re + net_profit\n        \n        if abs(current_re - expected_re) < 1:  # Allow for rounding differences\n            return True, \"Retained earnings rollforward is correct\"\n        else:\n            difference = current_re - expected_re\n            return False, f\"Retained earnings mismatch. Expected: ${expected_re:,.2f}, Actual: ${current_re:,.2f}, Difference: ${difference:,.2f}\"\n\n# Example usage\nif __name__ == \"__main__\":\n    # This is just for testing purposes\n    # In practice, you would use the class in your main application\n    try:\n        processor = ExcelProcessor(\"sample_entity_management_report.xlsx\")\n        pl_data = processor.extract_pl_data()\n        bs_data = processor.extract_bs_data()\n        print(\"Successfully extracted data from Excel file\")\n        print(\"P&L Data:\", pl_data)\n        print(\"Balance Sheet Data:\", bs_data)\n    except Exception as e:\n        print(f\"Error: {str(e)}\")"
        }
    ]
}